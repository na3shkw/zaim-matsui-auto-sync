# 機能要件

## 主要コンポーネント

### 松井証券データ取得モジュール (Matsui Scraper Module)

- 役割: Web スクレイピングライブラリ（Playwright）を使い、松井証券のサイトにログインし、各口座の資産評価額を取得します。
- 機能
    - セッション管理（Cookieの保存・復元）
    - ログイン処理
    - 投資信託残高照会ページへのナビゲーション
    - HTML から必要なデータ（評価額、評価損益、損益率）を抽出・整形

### 松井証券ログイン認証番号取得モジュール（Matsui Authentication Code Module）

- 役割: Web スクレイピングライブラリ（Playwright）を使い、Google メッセージにログインして SMS で送信された認証番号を取得します。
- 機能
    - Chromium のプロファイルを指定してログインする処理
    - 指定された SMS メッセージ会話に送信された新着メッセージを取得
    - ポーリング機能（最大60秒間、10秒間隔）
    - 認証番号を抽出・検証

### Zaim API 連携モジュール (Zaim API Client Module)

- 役割: Zaim API と通信し、取得した資産データを Zaim の口座に記録します。
- 機能
    - 事前に取得した OAuth アクセストークンを利用した API リクエスト送信
    - 資産データを Zaim API のフォーマットに変換
    - 入金または振替としてデータを登録する API リクエストの送信

### 設定管理モジュール (Config Module)

- 役割: アプリケーションの設定情報を型安全に管理します。
- 機能
    - JSON 形式の設定ファイルの読み込み
    - Zod スキーマによる設定値のバリデーション
    - 複数口座の設定サポート
    - 重複する Zaim 口座 ID の検出

### メインコントローラー (Main Controller)

- 役割: 全体の処理フローを管理します。
- 機能
    - 設定ファイルから複数口座の情報を読み込み
    - データ取得から Zaim への登録までの一連の処理を呼び出し
    - 口座ごとの差分計算と記録
    - エラーハンドリングとロギング
    - ドライランモードのサポート

## コンポーネント共通の要件

### 1. 仕様技術・ライブラリ

- TypeScript
- Playwright（Chromium）
- Commander.js（CLI フレームワーク）
- Pino（ロガー）
- dayjs（日時処理）
- Zod（スキーマバリデーション）

## 各コンポーネントの要件

### 松井証券データ取得モジュール (Matsui Scraper Module)

#### 1. 目的・役割

- 松井証券の投資信託残高照会から各口座の現在の資産評価額を取得する。

#### 2. 主要な機能リスト

- 環境変数からログイン ID とパスワードを読み込む。
- Playwright を使ってログインし、残高照会ページの HTML を取得する。
- ログインプロセス中に、松井証券ログイン認証番号取得モジュールを呼び出し、認証番号を取得する。
- 取得した HTML から、CSS セレクタを使って各口座の評価額データを抽出する。
- 抽出したデータ（文字列）を数値型に変換して返す。

#### 3. 入力 (Input)

- なし。ただし、以下の環境変数を参照する。
    - `MATSUI_LOGIN_ID`
    - `MATSUI_PASSWORD`
    - `CHROMIUM_USER_DATA_DIR_MATSUI`
    - `HEADLESS`（オプション、デフォルトは false）

#### 4. 出力 (Output)

- 下記のフォーマットのオブジェクト。
    ```typescript
    interface PositionDetails {
      [key: string]: {
        評価額: number | undefined;
        評価損益: number | undefined;
        損益率: number | undefined;  // 損益率 (%)
      };
    }
    ```

#### 5. その他特記事項

- ログインは多要素認証（MFA）が採用されているため、松井証券から SMS で送信される認証番号が必要。
- セッション管理のため Cookie を自動保存・復元する。
- 残高照会ページから全保有銘柄のデータを口座別に取得し、口座名をキーとした辞書形式で返す。
- ブラウザは Chromium に統一（ヘッドレスモード対応のため）。

### 松井証券ログイン認証番号取得モジュール（Matsui Authentication Code Module）

#### 1. 目的・役割

- 松井証券から送信される認証番号を Google メッセージから取得する。

#### 2. 主要な機能リスト

- 環境変数 `GOOGLE_MESSAGE_MATSUI_CONVERSATION_URL` で与えられた URL にアクセスする。
    - Google にログイン済みの Chromium プロファイルを利用する。プロファイルパスは環境変数 `CHROMIUM_USER_DATA_DIR_GOOGLE` から取得する。
- 認証コード検索ロジック:
    1. まず、ページ内に表示されているメッセージのうち、直近 3 分以内に受信した最新の認証コードを検索する。
    2. 見つからない場合、新着メッセージがないか最大 60 秒間ポーリングする（ポーリング間隔 10 秒）。
- メッセージから認証番号を抽出し、整数型に変換して返す。
    - メッセージのフォーマットは下記の正規表現の通り
        ```
        認証番号：\d{6}
        上記番号を認証番号欄に入力してください。
        認証番号の有効期限は3分です。
        松井証券
        ```
    - 上記の `\d{6}` の部分が認証番号である。

#### 3. 入力 (Input)

- なし。ただし、以下の環境変数を参照する。
    - `GOOGLE_MESSAGE_MATSUI_CONVERSATION_URL`
    - `CHROMIUM_USER_DATA_DIR_GOOGLE`

#### 4. 出力 (Output)

- 下記のフォーマットのオブジェクト。
    ```typescript
    interface MatsuiAuthenticationCode {
      authenticationCode: string;  // 認証コード（文字列）
      timestamp: Dayjs;  // 認証コードを受信したタイムスタンプ（dayjs オブジェクト）
    }
    ```

#### 5. その他特記事項

- 受信したメッセージが想定したフォーマットと異なる場合は例外を送出する。
- 松井証券データ取得モジュール (Matsui Scraper Module)から呼び出して実行する。
- ポーリングタイムアウトや間隔の設定値は定数で管理されている。

### Zaim API 連携モジュール (Zaim API Client Module)

#### 1. 目的・役割

- Zaim API にリクエストを送信し、取得した資産データを Zaim の口座に記録する。

#### 2. 主要な機能リスト

- 事前に手動で取得した OAuth アクセストークン等を環境変数から読み込む。
- Zaim API の仕様にそってリクエストを送信する。
- API からのレスポンスをもとにした結果オブジェクトを返す。

#### 3. 入力 (Input)

- 数値型の評価額
- （参考）利用する環境変数:
    - `ZAIM_CONSUMER_KEY`
    - `ZAIM_CONSUMER_SECRET`

#### 4. 出力 (Output)

- API リクエストのレスポンスオブジェクト

#### 5. その他特記事項

- エラーになった場合は例外を送出する。
- Zaim の API ドキュメントは https://dev.zaim.net/home である。

### 設定管理モジュール (Config Module)

#### 1. 目的・役割

- アプリケーションの設定情報を型安全に管理し、複数口座の同期を可能にする。

#### 2. 主要な機能リスト

- JSON 形式の設定ファイルの読み込み
- Zod スキーマによる設定値のバリデーション
- 複数口座の設定サポート
- 重複する Zaim 口座 ID の検出と拒否

#### 3. 入力 (Input)

- 環境変数 `CONFIG_FILE` で指定された JSON ファイル

#### 4. 出力 (Output)

- バリデーション済みの設定オブジェクト
    ```typescript
    interface AppConfig {
      accounts: {
        name: string;
        enabled: boolean;
        matsui: {
          type: "fund";
          accountName: string;
        };
        zaim: {
          accountId: number;
          categoryId: number;
        };
      }[];
    }
    ```

#### 5. その他特記事項

- 設定ファイルの形式エラーやバリデーションエラーは適切なエラーメッセージで報告
- Zaim 口座 ID の重複を防ぐことで、松井証券の異なる口座が同じ Zaim 口座に記録されることを防止

### メインコントローラー (Main Controller)

#### 1. 目的・役割

- CLI インターフェースを提供し、複数口座の同期処理フローを管理する。

#### 2. 主要な機能リスト

- `src/commands/sync-matsui-zaim.ts` に実装されている。
- Commander.js を使用した CLI インターフェース。
- 設定ファイルから有効な口座リストを読み込み。
- 口座ごとの前回総額データとの差分計算。
- 差分を Zaim API に送信して記録。
- 総額データファイルの更新。
- ドライランモードのサポート。

#### 3. 入力 (Input)

- CLI オプション:
  - `--pretty-log`: 整形されたログを出力
  - `--dry-run`: ドライラン（Zaim への記録を行わない）

#### 4. 出力 (Output)

- コンソールへのログ出力
- 総額データファイルの更新

#### 5. その他特記事項

- Pino ロガーを使用した適切なログ出力を行う。
- 各口座の処理完了後に総額データを更新するため、データ整合性を保つ。
- エラーハンドリングとプロセス終了コードの適切な設定。
